{% extends 'templates/_document.twig' %}

{% block content %}
  {% set blog_link = function('get_permalink', function('get_option', 'page_for_posts')) %}
  {% set case_study_link = function('get_post_type_archive_link', 'case_study') %}
  {% set service_link = function('get_post_type_archive_link', 'service') %}
  {% set areas_link = site.link ~ '/areas-covered/' %}

  {% if post.meta('hero_headline') or post.meta('hero_subheadline') %}
    <section class="page-hero hero">
      <div class="container hero-inner page-hero__inner">
        <div class="hero-content">
          {% if post.meta('hero_headline') %}
            <h1>{{ post.meta('hero_headline') }}</h1>
          {% endif %}
          {% if post.meta('hero_subheadline') %}
            <p class="hero-subtitle">{{ post.meta('hero_subheadline') }}</p>
          {% endif %}
          <div class="hero-ctas">
            {% if post.meta('hero_primary_cta_label') %}
              <a href="#contact" class="button">{{ post.meta('hero_primary_cta_label') }}</a>
            {% endif %}
            {% if post.meta('hero_secondary_cta_label') %}
              <a href="{{ service_link|default('/services/') }}" class="button button--outlined">{{ post.meta('hero_secondary_cta_label') }}</a>
            {% endif %}
          </div>
          {% if post.meta('trust_badges') %}
            <div class="hero-trust">
              {% for item in post.meta('trust_badges') %}
                {% if item.badge_name %}
                  <span class="trust-item">
                    {% if item.badge_image %}
                      <img src="{{ function('wp_get_attachment_image_url', item.badge_image, 'full') }}" alt="{{ item.badge_name|e }}" width="20" height="20">
                    {% endif %}
                    {{ item.badge_name }}
                  </span>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        </div>
        {% if post.thumbnail %}
          <div class="hero-illustration page-hero__media">
            <img src="{{ post.thumbnail.src|e }}" alt="{{ post.thumbnail.alt|e ?: post.title }}">
          </div>
        {% endif %}
      </div>
    </section>
  {% endif %}

  {% if post.meta('video_testimonials_headline') %}
    <section class="section section--muted">
      <div class="container">
        <header class="section-header">
          <h2>{{ post.meta('video_testimonials_headline') }}</h2>
        </header>
      </div>
    </section>
  {% endif %}

  {% if post.meta('services_headline') or post.meta('services') %}
    <section id="services" class="services">
      <div class="container">
        <header class="section-header">
          {% if post.meta('services_headline') %}
            <h2>{{ post.meta('services_headline') }}</h2>
          {% endif %}
          {% if post.meta('services_intro') %}
            <p class="section-intro">{{ post.meta('services_intro') }}</p>
          {% endif %}
        </header>
        {% set related_services = post.meta('services') %}
        {% if related_services %}
          <div class="services-grid">
            {% for service in related_services %}
              <article class="service-card">
                {% if service.meta('service_icon') %}
                  <div class="service-icon">
                    <img src="{{ function('wp_get_attachment_image_url', service.meta('service_icon'), 'full') }}" alt="" width="80" height="80">
                  </div>
                {% endif %}
                <h3>{{ service.title }}</h3>
                {% if service.meta('service_summary') %}
                  <p>{{ service.meta('service_summary') }}</p>
                {% else %}
                  <p>{{ service.excerpt.read_more(false) }}</p>
                {% endif %}
                <a href="{{ service.link|e('esc_url') }}" class="service-link">
                  {{ post.meta('services_cta_label')|default('Learn more →') }}
                </a>
              </article>
            {% endfor %}
          </div>
        {% endif %}
        {% if post.meta('services_cta_label') %}
          <p class="section-intro">
            <a href="{{ service_link|default('/services/') }}" class="button button--outlined">{{ post.meta('services_cta_label') }}</a>
          </p>
        {% endif %}
      </div>
    </section>
  {% endif %}

  {% if post.meta('featured_work_headline') or post.meta('featured_work_intro') %}
    <section id="work" class="case-study section section--contrast">
      <div class="container">
        <header class="section-header">
          {% if post.meta('featured_work_headline') %}
            <h2>{{ post.meta('featured_work_headline') }}</h2>
          {% endif %}
          {% if post.meta('featured_work_intro') %}
            <p class="section-intro">{{ post.meta('featured_work_intro') }}</p>
          {% endif %}
        </header>
        {% if case_studies %}
          {% set featured = featured_case_study ?? (case_studies|first) %}
          {% set testimonial = featured.meta('testimonial') %}
          {% set testimonial_quote = testimonial.quote ?? featured.meta('testimonial_quote') %}
          {% set testimonial_name = testimonial.name ?? featured.meta('testimonial_name') %}
          {% set testimonial_role_company = testimonial.role_company ?? featured.meta('testimonial_role_company') %}

          <div class="case-study-inner">
            <div class="case-study-content">
              <p class="section-eyebrow">Featured project</p>
              <h2>{{ featured.meta('project_headline')|default(featured.title) }}</h2>

              {% if testimonial_quote %}
                <blockquote>
                  <p>{{ testimonial_quote }}</p>
                  <footer>
                    <cite>
                      {% if testimonial_name %}
                        <strong>{{ testimonial_name }}</strong>
                      {% endif %}
                      {% if testimonial_role_company %}
                        <span>{{ testimonial_role_company }}</span>
                      {% elseif featured.meta('client_name') %}
                        <span>{{ featured.meta('client_name') }}</span>
                      {% endif %}
                    </cite>
                  </footer>
                </blockquote>
              {% endif %}

              <a href="{{ featured.link|e('esc_url') }}" class="btn btn-secondary">View case study →</a>
            </div>

            <div class="case-study-visual">
              {% if featured.meta('hero_image') %}
                <img src="{{ function('wp_get_attachment_image_url', featured.meta('hero_image'), 'large') }}" alt="{{ featured.meta('client_name')|default(featured.title) }}">
              {% elseif featured.thumbnail %}
                <img src="{{ featured.thumbnail.src|e }}" alt="{{ featured.thumbnail.alt|e ?: featured.title }}">
              {% endif %}
            </div>
          </div>

          <div class="client-logos">
            <p class="client-logos-label">
              Trusted by purpose-driven organisations
            </p>
            <div class="logo-grid">
              {% for cs in case_studies|slice(0, 4) %}
                <div class="client-logo" aria-label="{{ cs.meta('client_name')|default(cs.title) }}">
                  {{ cs.meta('client_name')|default(cs.title) }}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
        {% if post.meta('featured_work_cta_label') %}
          <p class="section-intro">
            <a href="{{ case_study_link|default('/case-studies/') }}" class="button">{{ post.meta('featured_work_cta_label') }}</a>
          </p>
        {% endif %}
      </div>
    </section>
  {% endif %}

  {% if post.meta('differentiators_headline') or post.meta('differentiators') %}
    <section id="about" class="values">
      <div class="container">
        <header class="section-header section-header--center">
          {% if post.meta('differentiators_headline') %}
            <h2>{{ post.meta('differentiators_headline') }}</h2>
          {% endif %}
        </header>
        {% if post.meta('differentiators') %}
          <div class="values-grid">
            {% for diff in post.meta('differentiators') %}
              <article class="value-card{{ loop.index == 2 ? ' value-card--accent' }}">
                <h3>{{ diff.diff_title }}</h3>
                {% if diff.diff_body %}
                  <p>{{ diff.diff_body }}</p>
                {% endif %}
              </article>
            {% endfor %}
          </div>
          <div class="methodology">
            <h3>How we work</h3>
            <div class="methodology-items">
              <div class="methodology-item">
                <span class="methodology-label">Custom WordPress</span>
                <span class="methodology-detail">Bespoke designs, never templates</span>
              </div>
              <div class="methodology-item">
                <span class="methodology-label">UK Cloud Hosting</span>
                <span class="methodology-detail">Fast, secure, 100% renewable</span>
              </div>
              <div class="methodology-item">
                <span class="methodology-label">Ongoing Partnership</span>
                <span class="methodology-detail">Support that grows with you</span>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </section>
  {% endif %}

  {% if post.meta('testimonials_headline') %}
    <section class="section section--muted">
      <div class="container">
        <header class="section-header section-header--center">
          <h2>{{ post.meta('testimonials_headline') }}</h2>
        </header>
      </div>
    </section>
  {% endif %}

  {% if post.meta('blog_preview_headline') or post.meta('blog_preview_intro') %}
    <section class="section">
      <div class="container">
        <header class="section-header">
          {% if post.meta('blog_preview_headline') %}
            <h2>{{ post.meta('blog_preview_headline') }}</h2>
          {% endif %}
          {% if post.meta('blog_preview_intro') %}
            <p class="section-intro">{{ post.meta('blog_preview_intro') }}</p>
          {% endif %}
        </header>
      </div>
      {{ renderComponent('GridPostsLatest', {'options': {'theme': 'light', 'maxPosts': 3, 'maxColumns': 3}}) }}
      {% if post.meta('blog_preview_cta_label') %}
        <div class="container">
          <p><a href="{{ blog_link|default('/blog/') }}" class="button button--outlined">{{ post.meta('blog_preview_cta_label') }}</a></p>
        </div>
      {% endif %}
    </section>
  {% endif %}

  {% if post.meta('areas_headline') or post.meta('areas') %}
    <section class="section section--contrast">
      <div class="container">
        <header class="section-header">
          {% if post.meta('areas_headline') %}
            <h2>{{ post.meta('areas_headline') }}</h2>
          {% endif %}
        </header>
        {% set areas = post.meta('areas') %}
        {% if areas %}
          <div class="card-grid">
            {% for area in areas %}
              <article class="card">
                <h3 class="card__title">{{ area.title }}</h3>
                {% if area.excerpt %}
                  <p class="card__meta">{{ area.excerpt.read_more(false) }}</p>
                {% endif %}
                <a href="{{ area.link|e('esc_url') }}" class="button button--text">
                  {{ post.meta('areas_cta_label')|default('Find your area') }}
                </a>
              </article>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </section>
  {% endif %}

  {% if post.meta('final_cta_headline') or post.meta('final_cta_body') %}
    {{ renderComponent('ContactSection') }}
  {% endif %}
{% endblock %}
